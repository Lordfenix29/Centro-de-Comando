<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Comando</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                    <i class="fas fa-rocket mr-3"></i>Centro de Comando
                </h1>
                <p class="text-gray-400 mt-1">Conectado vía Make.com</p>
            </div>
            <button onclick="cargarDatos()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-sync-alt mr-2"></i>Actualizar
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-12">
            <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
            <p>Cargando desde Make.com...</p>
        </div>

        <!-- Error -->
        <div id="error" class="hidden bg-red-500/20 border border-red-500 rounded-xl p-6 mb-6">
            <h3 class="font-bold text-red-400 mb-2">Error de conexión</h3>
            <p id="errorText" class="text-sm"></p>
            <p class="text-xs text-gray-400 mt-2">Intenta con el método alternativo abajo</p>
        </div>

        <!-- Stats -->
        <div id="stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass rounded-2xl p-6">
                <p class="text-gray-400 text-sm">Proyectos Activos</p>
                <h3 id="totalProyectos" class="text-3xl font-bold mt-2">-</h3>
            </div>
        </div>

        <!-- Proyectos -->
        <div id="proyectosSection" class="hidden glass rounded-2xl p-6">
            <h2 class="text-xl font-bold mb-4"><i class="fas fa-project-diagram mr-2 text-blue-400"></i>Proyectos</h2>
            <div id="listaProyectos" class="space-y-4"></div>
        </div>

        <!-- Config -->
        <div class="glass rounded-2xl p-6 mt-8">
            <h3 class="font-bold mb-4"><i class="fas fa-cog mr-2"></i>Configuración</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Webhook URL de Make.com:</label>
                    <input type="text" id="webhookUrl" placeholder="https://hook.make.com/..." 
                           class="w-full px-4 py-2 bg-gray-800 rounded-lg border border-gray-700">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Método de conexión:</label>
                    <select id="metodo" class="w-full px-4 py-2 bg-gray-800 rounded-lg border border-gray-700">
                        <option value="fetch">Fetch normal (puede fallar por CORS)</option>
                        <option value="jsonp">JSONP (evita CORS)</option>
                        <option value="proxy">Proxy CORS (alternativa)</option>
                    </select>
                </div>
                
                <button onclick="guardarConfig()" class="px-6 py-2 bg-green-600 rounded-lg hover:bg-green-700">
                    Guardar y Probar
                </button>
            </div>
        </div>
    </div>

    <script>
        let config = {
            webhookUrl: localStorage.getItem('makeWebhook') || '',
            metodo: localStorage.getItem('metodo') || 'fetch'
        };
        
        document.getElementById('webhookUrl').value = config.webhookUrl;
        document.getElementById('metodo').value = config.metodo;

        function guardarConfig() {
            config.webhookUrl = document.getElementById('webhookUrl').value;
            config.metodo = document.getElementById('metodo').value;
            
            localStorage.setItem('makeWebhook', config.webhookUrl);
            localStorage.setItem('metodo', config.metodo);
            
            cargarDatos();
        }

        async function cargarDatos() {
            if (!config.webhookUrl) {
                alert('Configura la URL primero');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('stats').classList.add('hidden');
            document.getElementById('proyectosSection').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');

            try {
                let proyectos = [];
                
                if (config.metodo === 'jsonp') {
                    // Método JSONP
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        const callbackName = 'cb_' + Date.now();
                        
                        window[callbackName] = function(data) {
                            proyectos = data;
                            delete window[callbackName];
                            document.body.removeChild(script);
                            resolve();
                        };
                        
                        script.onerror = reject;
                        script.src = config.webhookUrl + '?callback=' + callbackName;
                        document.body.appendChild(script);
                        
                        setTimeout(() => reject(new Error('Timeout')), 10000);
                    });
                    
                } else if (config.metodo === 'proxy') {
                    // Método Proxy
                    const proxyUrl = 'https://api.allorigins.win/get?url=';
                    const response = await fetch(proxyUrl + encodeURIComponent(config.webhookUrl), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getProjects' })
                    });
                    
                    const data = await response.json();
                    proyectos = JSON.parse(data.contents);
                    
                } else {
                    // Método Fetch normal
                    const response = await fetch(config.webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getProjects' })
                    });
                    
                    proyectos = await response.json();
                }

                mostrarProyectos(proyectos);

            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message;
                
                // Sugerir cambiar método
                if (config.metodo === 'fetch') {
                    document.getElementById('metodo').value = 'jsonp';
                    alert('Error de CORS detectado. Cambia el método a "JSONP" y guarda de nuevo.');
                }
            }
        }

        function mostrarProyectos(proyectos) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('stats').classList.remove('hidden');
            document.getElementById('stats').classList.add('grid');
            document.getElementById('proyectosSection').classList.remove('hidden');
            
            document.getElementById('totalProyectos').textContent = proyectos.length || 0;
            
            const container = document.getElementById('listaProyectos');
            container.innerHTML = '';

            if (!proyectos || proyectos.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No hay proyectos</p>';
                return;
            }

            proyectos.forEach(p => {
                const color = p.estado?.includes('Progreso') ? 'blue' : 
                             p.estado?.includes('Revisión') ? 'yellow' : 
                             p.estado?.includes('Completado') ? 'green' : 'red';
                
                const div = document.createElement('div');
                div.className = 'glass rounded-xl p-4 flex items-center justify-between hover:bg-white/5 transition';
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-${color}-500 flex items-center justify-center font-bold text-white">
                            ${p.nombre?.substring(0,2).toUpperCase() || 'PR'}
                        </div>
                        <div>
                            <h3 class="font-semibold">${p.nombre || 'Sin nombre'}</h3>
                            <p class="text-${color}-400">${p.estado || 'Sin estado'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-32 h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-${color}-500 rounded-full" style="width: ${p.progreso || 0}%"></div>
                        </div>
                        <span class="text-${color}-400 font-bold">${p.progreso || 0}%</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Cargar automáticamente si hay config
        if (config.webhookUrl) cargarDatos();
    </script>
</body>
</html>
